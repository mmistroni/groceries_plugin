<!DOCTYPE html>
<html lang="en">
<head>
  <!-- https://getbootstrap.com/docs/5.0/getting-started/introduction/-->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/public/css/fontawesomeall.min.css">
  <link rel="stylesheet" href="/public/css/bootstrap.min.css"/>
  <link rel="stylesheet"  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
  <link href= 
"https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" 
          rel="stylesheet" type="text/css" /> 
    <link rel="stylesheet" href= 
"https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
  <script src="/public/js/jquery-3.7.1.min.js"></script>
  <script src="/public/js/bootstrap.js""></script>
  <script src="/public/js/bootstrap.js""></script>
  <script src="/public/js/bootbox.min.js"></script>
  <script src="/public/js/bootstrap.datepicker.min.js"></script>
  <script src="/public/js/moment.js"></script>
  
  <title>Provision Management</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 5px;
      border: 1px solid #ddd;
    }
    #provision-table tbody {
      height: 400px;
      overflow-y: scroll;
    }
    .modal-header .close {
      display: none; /* Hide the close button */
    }
    .modal-content {
      -webkit-border-radius: 0px !important;
      -moz-border-radius: 0px !important;
      border-radius: 0px !important;
      -webkit-border: 0px !important;
      -moz-border: 0px !important;
      border: 0px !important;
    }
    .modal-dialog select {
      height: auto; /* Adjust as needed */
      min-height: 30px; /* Ensure minimum height */
      overflow-y: auto; /* Enable scrolling if necessary */
    }
    
  </style>
</head>
<body>
  <h1>Provision Management</h1>
  <p><b>Total Amount:</b> <span id="total-amount">0</span><i class="fa-brands fa-twitter"></i></p>

  <label for="optionList">Select a Value:</label>
  <select id="optionList">
    <option value=""></option>
    <option value="CAR">Car</option>
    <option value="TV">TV</option>
    <option value="PHONE">Phone</option>
    <option value="GAS">Gas</option>
    <option value="COUNCIL">Council</option>
    <option value="HOUSE_INSURANCE">House Insurance</option>
    <option value="LIFE_INSURANCE">Life Insurance</option>
    <option value="OTHER">Other</option>
  </select>

  <label for="startDate">Start Date:</label>
  <input type="date" id="startDate" value="2020-01-01">>

  <label for="endDate">End Date:</label>
  <input type="date"  id="endDate" value="9999-12-31">


  <table id="provision-table">
    <thead>
      <tr>
        <th>Provision Date</th>
        <th>Description</th>
        <th>Provision Type</th>
        <th>Amount</th>
        <th>User</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="provision-body"></tbody>
  </table>
  <br>
  <button id="create-btn">Create</button>
  
  <script>

    const today = new Date();
    const endOfYear = new Date(today.getFullYear(), 11, 31); // December 31st of the current year

    // Format the date as "YYYY-MM-DD"
    const formattedEndOfYear = endOfYear.toISOString().split('T')[0];

    // Set the value of the input field
    document.getElementById("endDate").value = formattedEndOfYear;

    // Adding event listeners
    const selectField = document.getElementById('optionList');
    const startDateField = document.getElementById('startDate');
    const endDateField = document.getElementById('endDate');

    selectField.addEventListener('change', () => {
      reloadPage();
    });
      
  
    const provisionTable = document.getElementById('provision-body');
    const createBtn = document.getElementById('create-btn');
    const totalAmountSpan = document.getElementById('total-amount');
    let selectedProvision = null; // Keeps track of selected provision for Update/Delete

    // Function to fetch provisions from backend using JSON request (replace with your actual API endpoint and logic)
    async function fetchProvisions() {

      const option = document.getElementById("optionList").value;
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const response = await fetch(`/api/provisions?option=${option}&start=${start}&end=${end}`); Â  
      if (!response.ok) {
        throw new Error(`Failed to fetch provisions: ${response.statusText}`);
      }
      const data = await response.json();
      // we should populate table
      return data;
    }


   

    createBtn.addEventListener("click", function() {
      alert('Creating');
      initializeBootboxDialog('', '', '', '', '');
      
      // Handle form submission within the popup (optional)
      const userForm = document.getElementById("provisionForm");
      userForm.addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent default form submission

        const datepickerElement = document.getElementById('datepicker');  
        const selectedDate = datepickerElement.value;
        const parsedDate = new Date(selectedDate);
        const formattedDate = moment(selectedDate).format('YYYYMMDD')
        // Access form data here (e.g., using formData or form elements)
        console.log('Formatted date:', formattedDate);
        const amountString = document.getElementById("amount").value;
        const amount = parseFloat(amountString)
        const desc = document.getElementById("description").value;
        const user = document.getElementById("user").value;
        const provtypeString = document.getElementById("provisionType").value; 
        console.log(`Cob: ${formattedDate}, amount: ${amount}, desc: ${desc}, 'User:${user}, 'Type:${provtypeString}`);
  
        
        const myFormDict = {
          "id": 0,
          "description": desc,
          "provisionType": provtypeString,
          "provisionDate": formattedDate,
          "provisionAmount": amount,
          "user": user
        }

        const postData = JSON.stringify(myFormDict);        
        const options = {
          method: 'POST',
          headers: {"content-type": "application/json"},
          body: postData
          };
          
          fetch('/addprovision2', options)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
              } else {
                window.location.reload();
                bootbox.hideAll();
              }})
          .then(data => console.log(data)) // Handle the response
          .catch(error => console.error('Error:', error));
        
        // Perform any actions with the data (e.g., send to server)
        // ...
         // Close the popup after processing
      });
    });

    function initializeBootboxDialog(provisionDate = '', provisionType='',
                      description = '', amount = '0', user='', provisionId=-1,update=false) {

      var btnText = 'Add';
      if (update) {
        btnText = 'Update'
      }                  
      bootbox.dialog({
        message: 
          '<form id="provisionForm">' +
            '<div class="form-group">' +
                '<label for="date" class="form-label">Date:</label>' +
                '<div class="input-group date" id="datepicker">' +
                  '<input type="text" class="form-control" id="provisionDate"  value="' + provisionDate + '">' +
                  '<input type="hidden" id="id"  value="' + provisionId + '">' + 
                  '<span class="input-group-addon">' +
                    '<i class="glyphicon glyphicon-calendar"></i>' +
                  '</span>' +
                '</div>' +
            '</div>' +
            '<div class="form-group">' +
              '<label for="role">ProvisionType:</label>' +
              '<select class="form-control" id="provisionType" name="provisionType" value="' + provisionType + '">'  +
                '<option value="CAR">Car</option>' +
                '<option value="TV">TV</option>' +
                '<option value="PHONE">Phone</option>' +
                '<option value="GAS">Gas</option>' +
                '<option value="COUNCIL">Council</option>' +
                '<option value="HOUSE_INSURANCE">House Insurance</option>' +
                '<option value="LIFE_INSURANCE">Life Insurance</option>' +
                '<option value="OTHER">Other</option>' +
              '</select>' +
            '</div>' +
            '<div class="form-group">' +
              '<label for="description">Description:</label>' +
              '<input type="text" class="form-control" id="description" name="description" value="' + description + '">'  +
            '</div>' +
            '<div class="form-group">' +
              '<label for="amount">Amount:</label>' +
              '<input type="text" class="form-control" id="amount" name="amount" value="' + amount +'">' +
            '</div>' +
            '<div class="form-group">' +
              '<label for="user">User:</label>' +
              '<input type="text" class="form-control" id="user" name="user" value="' + user +'">' +
            '</div>' +
            
            '<div class="form-group">' +
              '<button type="submit" class="btn btn-primary">' + btnText + '</button>' +
            '</div>' +
          '</form>' 
        ,
        buttons: {},
        onEscape:true ,
        centerVertical: true,// No default buttons,
        class : 'modal-lg'
      }).on('shown.bs.modal', function() {
        // Initialize datepicker after modal is shown
        $('#datepicker').datepicker({
          autoclose:true
        });
      });
  }




    function updateTable(provisions) {
      provisionTable.innerHTML = ""; // Clear existing rows
      let total = 0;
      for (const provision of provisions) {
        console.log(provision);
        const tableRow = document.createElement('tr');
        // need to convert enum integer to a string
        console.log('--provision:' + provision.name)
        const dateCell = document.createElement('td');
        dateCell.textContent = provision.provisionDate;
        tableRow.appendChild(dateCell);

        const descriptionCell = document.createElement('td');
        descriptionCell.textContent = provision.description;
        tableRow.appendChild(descriptionCell);

        
        const provisionTypeCell = document.createElement('td');
        provisionTypeCell.textContent = provision.total_cost;
        tableRow.appendChild(provisionTypeCell);
        
        
        const amountCell = document.createElement('td');
        amountCell.textContent = provision.provisionAmount;
        tableRow.appendChild(amountCell);
        total += provision.provisionAmount;

        const userCell = document.createElement('td');
        userCell.textContent = provision.user;
        tableRow.appendChild(userCell);

        const actionCell = document.createElement('td');
        const editBtn = document.createElement('button');
        editBtn.innerHTML = '<i class="fa-solid fa-edit"></i>';
        //editBtn.textContent = "Edit";
        editBtn.addEventListener('click', () => {
          alert('We need to edit provision:' + provision.description);
          selectedProvision = provision;
          

          initializeBootboxDialog(provision.provisionDate, 
                  provisionType=provision.provisionType,
                  provision.description, provision.provisionAmount, 
                  provision.user, provision.id, true);
      
          // Handle form submission within the popup (optional)
          const userForm = document.getElementById("provisionForm");
          userForm.addEventListener("submit", function(event) {
            event.preventDefault(); // Prevent default form submission

            const datepickerElement = document.getElementById('datepicker');  
            const selectedDate = datepickerElement.value;
            const parsedDate = new Date(selectedDate);
            const formattedDate = moment(selectedDate).format('YYYYMMDD')
            // Access form data here (e.g., using formData or form elements)
            console.log('Formatted date:', formattedDate);
            const amountString = document.getElementById("amount").value;
            const amount = parseFloat(amountString)
            const desc = document.getElementById("description").value;
            const user = document.getElementById("user").value;
            const provtypeString = document.getElementById("provisionType").value; 
            console.log(`Cob: ${formattedDate}, amount: ${amount}, desc: ${desc}, 'User:${user}, 'Type:${provtypeString}`);
      
            
            const myFormDict = {
              "id": provision.id,
              "description": desc,
              "provisionType": provtypeString,
              "provisionDate": formattedDate,
              "provisionAmount": amount,
              "user": user
            }

            const postData = JSON.stringify(myFormDict);        
            const options = {
              method: 'POST',
              headers: {"content-type": "application/json"},
              body: postData
              };
              
              fetch('/updateprovision', options)
              .then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                  } else {
                    window.location.reload();
                    bootbox.hideAll();
                  }})
              .then(data => console.log(data)) // Handle the response
              .catch(error => console.error('Error:', error));
            
        // Perform any actions with the data (e.g., send to server)
        // ...
         // Close the popup after processing
      });






          // Pre-fill a form or modal for editing (not shown here)
        });


        actionCell.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
        deleteBtn.addEventListener('click', () => {
          alert('We need to delete provision with id:' + provision.id);
          selectedProvision = provision;

          const myFormDict = {
            "id": selectedProvision.id
          }   
          const postData = JSON.stringify(myFormDict);     
          const options = {
            method: 'POST',
            headers: {"content-type": "application/json"},
            body: postData
            };


          fetch('/deleteprovision/', options)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
              } else {
                window.location.reload();
                bootbox.hideAll();
              }})
          .then(data => console.log(data)) // Handle the response
          .catch(error => console.error('Error:', error));
          
          // Pre-fill a form or modal for editing (not shown here)
        });


        actionCell.appendChild(deleteBtn);


        tableRow.appendChild(actionCell);

        provisionTable.appendChild(tableRow);
      }
      totalAmountSpan.textContent = total; // Update total amount
    }

    async function reloadPage() {
      try {
        const provisions = await fetchProvisions();
        updateTable(provisions);
      } catch (error) {
        console.error('Error fetching provisions:', error);
        // Handle errors appropriately (e.g., display an error message to the user)
      }
    };



    window.onload = reloadPage()

    // Implement logic for Create, Update, and Delete buttons using your backend API (not shown here)
  </script>
</body>

</html>
